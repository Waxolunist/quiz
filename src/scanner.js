define(["exports","./my-app.js"],function(_exports,_myApp){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.$qrScannerDefault=_exports.$qrScanner=void 0;function _templateObject_165d0e30971711e9a12f3787802a8791(){var data=babelHelpers.taggedTemplateLiteral(["\n      <style include=\"shared-styles\">\n        :host {\n          display: block;\n        }\n\n        #qrscanner {\n          width: 100%;\n        }\n      </style>\n\n      <div class=\"card\">\n        <h1>Scan your code</h1>\n        <video id=\"qrscanner\"></video>\n      </div>\n    "]);_templateObject_165d0e30971711e9a12f3787802a8791=function _templateObject_165d0e30971711e9a12f3787802a8791(){return data};return data}var QrScanner=/*#__PURE__*/function(){babelHelpers.createClass(QrScanner,null,[{key:"hasCamera",/* async */value:function hasCamera(){// note that enumerateDevices can always be called and does not prompt the user for permission. However, device
// labels are only readable if served via https and an active media stream exists or permanent permission is
// given. That doesn't matter for us though as we don't require labels.
return navigator.mediaDevices.enumerateDevices().then(function(devices){return devices.some(function(device){return"videoinput"===device.kind})}).catch(function(){return!1})}}]);function QrScanner(video,onDecode){var canvasSize=2<arguments.length&&arguments[2]!==void 0?arguments[2]:QrScanner.DEFAULT_CANVAS_SIZE;babelHelpers.classCallCheck(this,QrScanner);this.$video=video;this.$canvas=document.createElement("canvas");this._onDecode=onDecode;this._active=!1;this._paused=!1;this.$canvas.width=canvasSize;this.$canvas.height=canvasSize;this._sourceRect={x:0,y:0,width:canvasSize,height:canvasSize};this._onCanPlay=this._onCanPlay.bind(this);this._onPlay=this._onPlay.bind(this);this._onVisibilityChange=this._onVisibilityChange.bind(this);this.$video.addEventListener("canplay",this._onCanPlay);this.$video.addEventListener("play",this._onPlay);document.addEventListener("visibilitychange",this._onVisibilityChange);this._qrWorker=new Worker(QrScanner.WORKER_PATH)}babelHelpers.createClass(QrScanner,[{key:"destroy",value:function destroy(){this.$video.removeEventListener("canplay",this._onCanPlay);this.$video.removeEventListener("play",this._onPlay);document.removeEventListener("visibilitychange",this._onVisibilityChange);this.stop();this._qrWorker.postMessage({type:"close"})}/* async */},{key:"start",value:function start(){var _this=this;if(this._active&&!this._paused){return Promise.resolve()}if("https:"!==window.location.protocol){// warn but try starting the camera anyways
console.warn("The camera stream is only accessible if the page is transferred via https.")}this._active=!0;this._paused=!1;if(document.hidden){// camera will be started as soon as tab is in foreground
return Promise.resolve()}clearTimeout(this._offTimeout);this._offTimeout=null;if(this.$video.srcObject){// camera stream already/still set
this.$video.play();return Promise.resolve()}var facingMode="environment";return this._getCameraStream("environment",!0).catch(function(){// we (probably) don't have an environment camera
facingMode="user";return _this._getCameraStream();// throws if camera is not accessible (e.g. due to not https)
}).then(function(stream){_this.$video.srcObject=stream;_this._setVideoMirror(facingMode)}).catch(function(e){_this._active=!1;throw e})}},{key:"stop",value:function stop(){this.pause();this._active=!1}},{key:"pause",value:function pause(){var _this2=this;this._paused=!0;if(!this._active){return}this.$video.pause();if(this._offTimeout){return}this._offTimeout=setTimeout(function(){var track=_this2.$video.srcObject&&_this2.$video.srcObject.getTracks()[0];if(!track)return;track.stop();_this2.$video.srcObject=null;_this2._offTimeout=null},300)}/* async */},{key:"setGrayscaleWeights",value:function setGrayscaleWeights(red,green,blue){var useIntegerApproximation=3<arguments.length&&arguments[3]!==void 0?arguments[3]:!0;this._qrWorker.postMessage({type:"grayscaleWeights",data:{red:red,green:green,blue:blue,useIntegerApproximation:useIntegerApproximation}})}},{key:"setInversionMode",value:function setInversionMode(inversionMode){this._qrWorker.postMessage({type:"inversionMode",data:inversionMode})}},{key:"_onCanPlay",value:function _onCanPlay(){this._updateSourceRect();this.$video.play()}},{key:"_onPlay",value:function _onPlay(){this._updateSourceRect();this._scanFrame()}},{key:"_onVisibilityChange",value:function _onVisibilityChange(){if(document.hidden){this.pause()}else if(this._active){this.start()}}},{key:"_updateSourceRect",value:function _updateSourceRect(){var smallestDimension=Math.min(this.$video.videoWidth,this.$video.videoHeight),sourceRectSize=Math.round(2/3*smallestDimension);this._sourceRect.width=this._sourceRect.height=sourceRectSize;this._sourceRect.x=(this.$video.videoWidth-sourceRectSize)/2;this._sourceRect.y=(this.$video.videoHeight-sourceRectSize)/2}},{key:"_scanFrame",value:function _scanFrame(){var _this3=this;if(!this._active||this.$video.paused||this.$video.ended)return!1;// using requestAnimationFrame to avoid scanning if tab is in background
requestAnimationFrame(function(){QrScanner.scanImage(_this3.$video,_this3._sourceRect,_this3._qrWorker,_this3.$canvas,!0).then(_this3._onDecode,function(error){if(_this3._active&&"QR code not found."!==error){console.error(error)}}).then(function(){return _this3._scanFrame()})})}},{key:"_getCameraStream",value:function _getCameraStream(facingMode){var exact=1<arguments.length&&arguments[1]!==void 0?arguments[1]:!1,constraintsToTry=[{width:{min:1024}},{width:{min:768}},{}];if(facingMode){if(exact){facingMode={exact:facingMode}}constraintsToTry.forEach(function(constraint){return constraint.facingMode=facingMode})}return this._getMatchingCameraStream(constraintsToTry)}},{key:"_getMatchingCameraStream",value:function _getMatchingCameraStream(constraintsToTry){var _this4=this;if(0===constraintsToTry.length){return Promise.reject("Camera not found.")}return navigator.mediaDevices.getUserMedia({video:constraintsToTry.shift()}).catch(function(){return _this4._getMatchingCameraStream(constraintsToTry)})}},{key:"_setVideoMirror",value:function _setVideoMirror(facingMode){// in user facing mode mirror the video to make it easier for the user to position the QR code
var scaleFactor="user"===facingMode?-1:1;this.$video.style.transform="scaleX("+scaleFactor+")"}}],[{key:"scanImage",value:function scanImage(imageOrFileOrUrl){var sourceRect=1<arguments.length&&arguments[1]!==void 0?arguments[1]:null,worker=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null,canvas=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null,fixedCanvasSize=4<arguments.length&&arguments[4]!==void 0?arguments[4]:!1,alsoTryWithoutSourceRect=5<arguments.length&&arguments[5]!==void 0?arguments[5]:!1,createdNewWorker=!1,promise=new Promise(function(resolve,reject){if(!worker){worker=new Worker(QrScanner.WORKER_PATH);createdNewWorker=!0;worker.postMessage({type:"inversionMode",data:"both"});// scan inverted color qr codes too
}var timeout,_onMessage,_onError;_onMessage=function onMessage(event){if("qrResult"!==event.data.type){return}worker.removeEventListener("message",_onMessage);worker.removeEventListener("error",_onError);clearTimeout(timeout);if(null!==event.data.data){resolve(event.data.data)}else{reject("QR code not found.")}};_onError=function onError(e){worker.removeEventListener("message",_onMessage);worker.removeEventListener("error",_onError);clearTimeout(timeout);var errorMessage=!e?"Unknown Error":e.message||e;reject("Scanner error: "+errorMessage)};worker.addEventListener("message",_onMessage);worker.addEventListener("error",_onError);timeout=setTimeout(function(){return _onError("timeout")},3e3);QrScanner._loadImage(imageOrFileOrUrl).then(function(image){var imageData=QrScanner._getImageData(image,sourceRect,canvas,fixedCanvasSize);worker.postMessage({type:"decode",data:imageData},[imageData.data.buffer])}).catch(_onError)});if(sourceRect&&alsoTryWithoutSourceRect){promise=promise.catch(function(){return QrScanner.scanImage(imageOrFileOrUrl,null,worker,canvas,fixedCanvasSize)})}promise=promise.finally(function(){if(!createdNewWorker)return;worker.postMessage({type:"close"})});return promise}},{key:"_getImageData",value:function _getImageData(image){var sourceRect=1<arguments.length&&arguments[1]!==void 0?arguments[1]:null,canvas=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null,fixedCanvasSize=3<arguments.length&&arguments[3]!==void 0?arguments[3]:!1;canvas=canvas||document.createElement("canvas");var sourceRectX=sourceRect&&sourceRect.x?sourceRect.x:0,sourceRectY=sourceRect&&sourceRect.y?sourceRect.y:0,sourceRectWidth=sourceRect&&sourceRect.width?sourceRect.width:image.width||image.videoWidth,sourceRectHeight=sourceRect&&sourceRect.height?sourceRect.height:image.height||image.videoHeight;if(!fixedCanvasSize&&(canvas.width!==sourceRectWidth||canvas.height!==sourceRectHeight)){canvas.width=sourceRectWidth;canvas.height=sourceRectHeight}var context=canvas.getContext("2d",{alpha:!1});context.imageSmoothingEnabled=!1;// gives less blurry images
context.drawImage(image,sourceRectX,sourceRectY,sourceRectWidth,sourceRectHeight,0,0,canvas.width,canvas.height);return context.getImageData(0,0,canvas.width,canvas.height)}/* async */},{key:"_loadImage",value:function _loadImage(imageOrFileOrUrl){if(babelHelpers.instanceof(imageOrFileOrUrl,HTMLCanvasElement)||babelHelpers.instanceof(imageOrFileOrUrl,HTMLVideoElement)||window.ImageBitmap&&babelHelpers.instanceof(imageOrFileOrUrl,window.ImageBitmap)||window.OffscreenCanvas&&babelHelpers.instanceof(imageOrFileOrUrl,window.OffscreenCanvas)){return Promise.resolve(imageOrFileOrUrl)}else if(babelHelpers.instanceof(imageOrFileOrUrl,Image)){return QrScanner._awaitImageLoad(imageOrFileOrUrl).then(function(){return imageOrFileOrUrl})}else if(babelHelpers.instanceof(imageOrFileOrUrl,File)||babelHelpers.instanceof(imageOrFileOrUrl,URL)||"string"===typeof imageOrFileOrUrl){var image=new Image;if(babelHelpers.instanceof(imageOrFileOrUrl,File)){image.src=URL.createObjectURL(imageOrFileOrUrl)}else{image.src=imageOrFileOrUrl}return QrScanner._awaitImageLoad(image).then(function(){if(babelHelpers.instanceof(imageOrFileOrUrl,File)){URL.revokeObjectURL(image.src)}return image})}else{return Promise.reject("Unsupported image type.")}}/* async */},{key:"_awaitImageLoad",value:function _awaitImageLoad(image){return new Promise(function(resolve,reject){if(image.complete&&0!==image.naturalWidth){// already loaded
resolve()}else{var _onLoad,_onError2;_onLoad=function onLoad(){image.removeEventListener("load",_onLoad);image.removeEventListener("error",_onError2);resolve()};_onError2=function onError(){image.removeEventListener("load",_onLoad);image.removeEventListener("error",_onError2);reject("Image load error")};image.addEventListener("load",_onLoad);image.addEventListener("error",_onError2)}})}}]);return QrScanner}();_exports.$qrScannerDefault=QrScanner;QrScanner.DEFAULT_CANVAS_SIZE=400;QrScanner.WORKER_PATH="qr-scanner-worker.min.js";var qrScanner={default:QrScanner};_exports.$qrScanner=qrScanner;var ScannerView=/*#__PURE__*/function(_QuestionViewElement){babelHelpers.inherits(ScannerView,_QuestionViewElement);function ScannerView(){babelHelpers.classCallCheck(this,ScannerView);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(ScannerView).apply(this,arguments))}babelHelpers.createClass(ScannerView,[{key:"ready",value:function ready(){var _this5=this;babelHelpers.get(babelHelpers.getPrototypeOf(ScannerView.prototype),"ready",this).call(this);var videoElem=this.shadowRoot.getElementById("qrscanner");QrScanner.WORKER_PATH="".concat(this.rootPath,"node_modules/qr-scanner/qr-scanner-worker.min.js");setTimeout(function(e){return _this5._playsound("gameshow")},0);setTimeout(function(e){_this5._qrScanner=new QrScanner(videoElem,function(result){return _this5._onScanInput(result)});_this5._qrScanner.start()},100)}},{key:"detached",value:function detached(){this._qrScanner.destroy();this._qrScanner=null}},{key:"_onScanInput",value:function _onScanInput(result){var _this6=this;console.log("decoded qr code:",result);if(result){var split=result.split("-");if(2===split.length&&"q"===split[0]&&Number.isInteger(parseInt(split[1]))){this._playsound("ding",function(e){return _this6._changePath("question/"+split[1])})}}}}],[{key:"template",get:function get(){return(0,_myApp.html)(_templateObject_165d0e30971711e9a12f3787802a8791())}}]);return ScannerView}(_myApp.QuestionViewElement);window.customElements.define("scanner-view",ScannerView)});